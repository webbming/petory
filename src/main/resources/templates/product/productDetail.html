<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìƒì„¸</title>
    <style>
		body {
		    font-family: Arial, sans-serif;
		    background-color: #f4f7fc;
		    margin: 0;
		    padding: 0;
		}
		.container, .content-section {
		    display: flex;
		    justify-content: center;
		    width: 80%;
		    max-width: 1200px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
		    margin: 20px auto;
		    background-color: white;
		    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		    padding: 20px;
		    border-radius: 8px;
		}
		.container {
		    flex-direction: row;
		    align-items: flex-start;
		}
		.content-section {
		    flex-direction: column;
		}
		.product-image {
		    flex: 1;
		    margin-right: 20px;
		}
		.product-info {
		    flex: 2;
		    padding-left: 20px;
		}
		.product-description, .product-detail-images, .reviews {
		    text-align: center;
		    margin-top: 20px;
		}
		.product-image img, .product-detail-images img {
		    max-width: 100%;
		    max-width: 900px;
		    height: auto;
		    border-radius: 8px;
		    display: block;
	        margin: 0 auto 10px;
	        object-fit: contain;
		}
		.product-image img {
		    width: 500px;
		    height: auto;
		    max-height: 500px;
		    object-fit: contain;
		}
		.price {
		    color: #4A90E2;
		    font-size: 18px;
		    font-weight: bold;
		}
		.reviews, .review, .comments {
		    background-color: #fff;
		    padding: 15px;
		    margin-top: 10px;
		    border-radius: 5px;
		    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
		    margin-bottom: 10px; /* ë¦¬ë·° ê°„ êµ¬ë¶„ */
		}
		.reviews {
		    max-width: 800px;
		    width: 85%;
		    margin: 20px auto;
		    padding: 20px;
		    background: white;
		    border-radius: 10px;
		    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}
		.form-input, .form-textarea {
		    width: 100%;
		    padding: 8px;
		    margin-top: 5px;
		    border-radius: 4px;
		    border: 1px solid #ddd;
		}
		.form-label {
		    display: block;
		    margin-top: 20px;
		    color: #666;
		}
		.review {
		    display: flex;
		    flex-wrap: wrap;  /* ğŸ’¡ ë‚´ë¶€ ìš”ì†Œê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ë‹¤ìŒ ì¤„ë¡œ ìë™ ë°°ì¹˜ */
		    align-items: flex-start;
		    gap: 15px;
		    background: #f9f9f9;
		    padding: 15px;
		    margin-top: 10px;
		    border-radius: 10px;
		    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		    min-height: 120px;  /* ìµœì†Œ ë†’ì´ ì„¤ì • */
		    overflow: hidden;
		    position: relative;
		}
		.review img {
		    width: 80px;
		    height: 80px;
		    border-radius: 10px;
		    flex-shrink: 0;
		}
		.review-content {
		    flex-grow: 1;
		    min-width: 60%;
		    max-width: 65%;
		    word-wrap: break-word;
		    white-space: normal;  /* ğŸ’¡ ê¸´ ê¸€ë„ ìë™ ì¤„ë°”ê¿ˆ */
		    overflow: hidden;
		}
		.comments {
		    width: 100%;
		    background: #e8e8e8;
		    padding: 10px;
		    margin-top: 15px;
		    border-radius: 10px;
		    overflow: visible;  /* ğŸ’¡ ë‚´ë¶€ ìš”ì†Œê°€ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ì„¤ì • */
		    word-wrap: break-word;
		}
		.comment-section {
		    flex-grow: 1;
		    min-width: 30%;
		    max-width: 35%;
		    text-align: right;
		    display: flex;
		    flex-direction: column;
		    align-items: flex-end;
		}
		.comment-section form {
		    width: 100%;
		}
		
		.comment-section input {
		    width: 100%;
		    max-width: 250px;
		    padding: 5px;
		    margin-bottom: 5px;
		    border-radius: 5px;
		    border: 1px solid #ddd;
		}
		
		.comment-section button {
		    padding: 5px 10px;
		    font-size: 14px;
		    cursor: pointer;
		}
		.comment {
		    padding: 5px;
		    border-bottom: 1px solid #ddd;
		}
		.comment:last-child {
		    border-bottom: none;
		}
		@media (max-width: 768px) {
		    .container, .content-section {
		        flex-direction: column;
		        width: 95%;
		    }
		    .product-info {
		        width: 100%;
		        padding-left: 0;
		    }
		}
		@media (max-width: 1200px) {
		    .product-detail-images img {
		        max-width: 90%;  /* í™”ë©´ì´ ì‘ì•„ì§€ë©´ ìœ ë™ì ìœ¼ë¡œ ì¤„ì–´ë“¦ */
		    }
		}
	
		@media (max-width: 1200px) {
		    .container, .content-section {
		        width: 90%; /* í™”ë©´ì´ ì‘ì•„ì§€ë©´ ìœ ë™ì ìœ¼ë¡œ ì¤„ì–´ë“¦ */
		    }
		}
		@media (max-width: 768px) {
		    .product-detail-images img {
		        max-width: 100%;  /* ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ì— ë§ì¶¤ */
		    }
		}
		.wishlist-btn:hover {
		    color: red;
		}
		.add-to-cart, .wishlist-btn {
		    margin-top: 20px;
		    padding: 10px 20px;
		    color: white;
		    border: none;
		    cursor: pointer;
		    font-size: 16px;
		    border-radius: 20px;
		    width: 100%;
		    flex: 1;
		}
		.add-to-cart {
		    background-color: #4A90E2;
		    color: white;
		}
		.wishlist-btn {
		    background-color: white;
		    color: #4A90E2;
		    border: 1px solid #4A90E2;
		}
		.form-buttons {
		    display: flex;
		    justify-content: space-between;
		    width: 100%; /* ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
		    margin-top: 10px; /* ë²„íŠ¼ê³¼ ê°€ê²© ì‚¬ì´ ê°„ê²© ì¡°ì • */
		}
		.hidden {
		    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
		}
		.visible {
		    display: block; /* ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë§Œ í‘œì‹œ */
		}
		.description-img {
		    width: 100%;
		    margin-bottom: 10px;
		}
		#toggle-button {
		    width: 100%;
		    padding: 10px;
		    background-color: #f5f5f5;
		    border: none;
		    cursor: pointer;
		    font-size: 16px;
		}
		#hidden-description {
	        display: none;
	        opacity: 0;
	        transition: opacity 0.3s ease-in-out;
	    }
	
	    #hidden-description.show {
	        display: block;
	        opacity: 1;
	    }
	
	    #toggle-button {
	        display: flex;
	        align-items: center;
	        justify-content: center;
	        width: 100%;
	        padding: 12px;
	        background-color: #ffffff;
	        border: 1px solid #ddd;
	        border-radius: 8px;
	        cursor: pointer;
	        font-size: 16px;
	        font-weight: bold;
	        color: #333;
	        margin-top: 10px;
	        transition: background-color 0.3s ease-in-out;
	    }
	
	    #toggle-button:hover {
	        background-color: #f5f5f5;
	    }
	
	    #toggle-button i {
	        margin-left: 5px;
	        transition: transform 0.3s ease-in-out;
	    }
	
	    #toggle-button.active i {
	        transform: rotate(180deg);
	    }	
    </style>
	    <script>
	    document.addEventListener("DOMContentLoaded", function () {
	        calculateAverageRating();
	        updateTotalPrice();
	    });
	
	    function updateTotalPrice() {
	        let basePrice = parseInt(document.getElementById('product-price').innerText.replace('ì›', ''));
	        let totalPrice = 0;
	
	        selectedOptions.forEach(option => {
	            totalPrice += basePrice * option.quantity;
	        });
	
	        document.getElementById('total-price').innerText = totalPrice + 'ì›';
	    }
	
	    function calculateAverageRating() {
	        let ratings = document.querySelectorAll('.review-rating');
	        let total = 0;
	        let count = ratings.length;
	
	        ratings.forEach(rating => {
	            total += parseInt(rating.dataset.rating);
	        });
	
	        let avg = count > 0 ? (total / count).toFixed(1) : 0;
	        document.getElementById('average-rating').innerText = avg + "ì ";
	
	        let stars = 'â­'.repeat(Math.round(avg)) + 'â˜†'.repeat(5 - Math.round(avg));
	        document.getElementById('average-stars').innerText = stars;
	    }
	
	    let selectedOptions = [];
	
	    function addOption() {
	        const selectBox = document.getElementById("product-option");
	        const selectedText = selectBox.options[selectBox.selectedIndex].text;
	        const selectedValue = selectBox.value;
	
	        if (!selectedValue) return;
	        if (selectedOptions.some(opt => opt.value === selectedValue)) {
	            alert("ì´ë¯¸ ì„ íƒí•œ ì˜µì…˜ì…ë‹ˆë‹¤.");
	            return;
	        }
	
	        selectedOptions.push({
	            value: selectedValue,
	            text: selectedText,
	            quantity: 1
	        });
	
	        updateOptionList();
	    }
	
	    function updateOptionList() {
	        const container = document.getElementById("selected-options");
	        container.innerHTML = "";
	
	        selectedOptions.forEach((opt, index) => {
	            const optionRow = document.createElement("div");
	            optionRow.classList.add("option-item");
	            optionRow.innerHTML = `
	                <span><strong>${opt.text}</strong></span>
	                <button onclick="changeQuantity(${index}, -1)">-</button>
	                <span>${opt.quantity}</span>
	                <button onclick="changeQuantity(${index}, 1)">+</button>
	                <button onclick="removeOption(${index})">X</button>
	            `;
	            container.appendChild(optionRow);
	        });
	
	        updateTotalPrice(); // âœ… ì˜µì…˜ ë³€ê²½ ì‹œ ì´ ê°€ê²© ì—…ë°ì´íŠ¸
	    }
	
	    function changeQuantity(index, change) {
	        selectedOptions[index].quantity += change;
	        if (selectedOptions[index].quantity < 1) {
	            selectedOptions[index].quantity = 1;
	        }
	        updateOptionList();
	    }
	
	    function removeOption(index) {
	        selectedOptions.splice(index, 1);
	        updateOptionList();
	    }
	
	    document.addEventListener("DOMContentLoaded", function () {
	        var wishlistButton = document.getElementById('wishlistButton');

	        if (wishlistButton) {
	            wishlistButton.addEventListener('click', function () {
	                var userId = document.getElementById('userId').value;  // ìœ ì € ID ê°€ì ¸ì˜¤ê¸°
	                var productId = document.getElementById('productId').value;  // ìƒí’ˆ ID ê°€ì ¸ì˜¤ê¸°

	                if (!userId || !productId) {
	                    alert('ìœ ì € ì •ë³´ ë˜ëŠ” ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
	                    return;
	                }

	                fetch(`/wishlist/add?userId=${userId}&productId=${productId}`, {
	                    method: 'POST'
	                })
	                .then(response => response.json())
	                .then(data => {
	                    console.log('ì°œ ëª©ë¡ ì¶”ê°€ ì„±ê³µ:', data);
	                    alert('ì°œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
	                    wishlistButton.classList.toggle('active');
	                })
	                .catch(error => {
	                    console.error('ì°œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	                    alert('ì´ë¯¸ ì¶”ê°€ í•œ ìƒí’ˆì…ë‹ˆë‹¤.');
	                });
	            });
	        }
	    });
	    function toggleDescription() {
	        let hiddenSection = document.getElementById("hidden-description");
	        let button = document.getElementById("toggle-button");
	        let icon = button.querySelector("i");

	        if (hiddenSection.classList.contains("show")) {
	            hiddenSection.classList.remove("show");
	            setTimeout(() => hiddenSection.style.display = "none", 300);
	            button.innerHTML = 'ìƒì„¸ì •ë³´ í¼ì³ë³´ê¸° <i>â–¼</i>';
	        } else {
	            hiddenSection.style.display = "block";
	            setTimeout(() => hiddenSection.classList.add("show"), 10);
	            button.innerHTML = 'ìƒì„¸ì •ë³´ ì ‘ê¸° <i>â–²</i>';
	        }
	    }
	</script>
</head>
<body>
    <div class="container">
        <div class="product-image">
            <img th:src="@{${product.imageUrl}}" alt="ëŒ€í‘œ ì´ë¯¸ì§€">
        </div>
        <div class="product-info">
            <p><strong>ìƒí’ˆëª…:</strong> <span th:text="${product.productName}"></span></p>
            <p><strong>ê°€ê²©:</strong> <span id="product-price" class="price" th:text="${product.price} + 'ì›'"></span></p>
            <p><strong>ë‚´ìš©:</strong> <span th:text="${product.content}"></span></p>
            <p><strong>ì˜µì…˜:</strong>
                <select id="product-option" onchange="addOption()">
                    <option value="">ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="opt : ${#strings.arraySplit(product.option, ',')}" 
                            th:text="${opt}" th:value="${opt}" th:data-price="1000"></option>
                </select>
            </p>
            <div id="selected-options" class="option-list"></div>
            <p><strong>ì´ ê°€ê²©:</strong> <span id="total-price">0ì›</span></p>
            <form th:action="@{'/cart/add'}" method="post" class="form-buttons">
            	<input type="hidden" id="userId" value="1">
			    <input type="hidden" id="productId" th:value="${product.productId}" />
			    <input type="hidden" name="quantity" id="quantity-value" th:value="1"/>
			    <button id="wishlistButton" type="button" class="wishlist-btn">
			        <i class="fa fa-heart"></i>ì°œí•˜ê¸°
			    </button>
			    <button type="submit" class="add-to-cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
			</form>
        </div>
    </div>

    <div class="content-section">
        <div class="product-description">
            <h3>ìƒí’ˆ ì„¤ëª…</h3>
            <p><span th:text="${product.description}"></span></p>
        </div>
        
        <div class="product-detail-images">
		    <!-- ì²« ë²ˆì§¸ ì´ë¯¸ì§€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ -->
		    <img th:src="@{${product.imageUrls[0]}}" alt="ìƒì„¸ ì´ë¯¸ì§€" class="description-img">
		
		    <!-- ë‚˜ë¨¸ì§€ ì´ë¯¸ì§€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ -->
		    <div id="hidden-description">
		        <div th:each="img, iterStat : ${product.imageUrls}" th:if="${iterStat.index > 0}">
		            <img th:src="@{${img}}" alt="ìƒì„¸ ì´ë¯¸ì§€" class="description-img">
		        </div>
		    </div>
		
		    <!-- í¼ì³ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ -->
		    <button id="toggle-button" onclick="toggleDescription()">
		        ìƒì„¸ì •ë³´ í¼ì³ë³´ê¸° <i>â–¼</i>
		    </button>
		</div>
		
        <div class="reviews">
            <h3>ë¦¬ë·°</h3>
            <p><strong>í‰ê·  í‰ì :</strong> <span id="average-rating">0ì </span> (<span id="average-stars"></span>)</p>
            <form th:action="@{'/products/' + ${product.productId} + '/reviews'}" method="post" enctype="multipart/form-data">
                <input type="number" name="rating" min="1" max="5" placeholder="í‰ì  (1-5)" required>
                <textarea name="comment" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”" required></textarea>
                <input type="file" name="imageFile" accept="image/*">
                <button type="submit">ë¦¬ë·° ë“±ë¡</button>
            </form>
            
            <div th:each="review : ${reviews}" class="review">
                <img th:if="${review.imageUrl}"
                     th:src="@{${review.imageUrl}}"
                     alt="Review Image" style="width:100px; height:100px;">
                
                <p class="review-rating" th:data-rating="${review.rating}">
                    <strong>í‰ì :</strong>
                    <span th:text="${#strings.repeat('â­', review.rating)}"></span>
                    <span th:text="${#strings.repeat('â˜†', 5 - review.rating)}"></span>
                    (<span th:text="${review.rating}"></span>ì )
                </p>
        
                <p th:text="${review.comment}"></p>
                <p th:text="${#dates.format(review.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></p>
        
                <div class="comments">
                    <div th:each="comment : ${reviewComments[review.reviewId]}">
                        <p th:text="${comment['userId']} + ' : ' + ${comment['content']}"></p>
                        <p th:text="${#dates.format(comment['createdAt'], 'yyyy-MM-dd HH:mm:ss')}"></p>
                    </div>
                    
                    <form th:action="@{'/products/' + ${product.productId} + '/reviews/' + ${review.reviewId} + '/comments'}" method="post">
                        <input type="text" name="content" placeholder="ëŒ“ê¸€ ì…ë ¥" required/>
                        <input type="hidden" name="userId" value="1"/>
                        <button type="submit">ëŒ“ê¸€ ì¶”ê°€</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <a th:href="@{'/products/edit/' + ${product.productId}}">ìˆ˜ì •í•˜ê¸°</a>
    <form th:action="@{'/products/delete/' + ${product.productId}}" method="post">
        <input type="hidden" name="_method" value="delete">
        <button type="submit" onclick="return confirm('ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œí•˜ê¸°</button>
    </form>
    <a href="/products">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
	<a th:href="@{/wishlist(userId=${userId})}">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë³´ê¸°</a>

</body>
</html>
